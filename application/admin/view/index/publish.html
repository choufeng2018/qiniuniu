<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="__PUBLIC__/common/css/bootstrap.css">
    <link rel="stylesheet" href="__PUBLIC__/admin/css/main.css"/>
    <link href="__PUBLIC__/ueditor/themes/default/css/ueditor.min.css" rel="stylesheet">
    <script src="__PUBLIC__/common/js/jquery-3.2.1.min.js"></script>
    <script src="__PUBLIC__/common/js/bootstrap.min.js"></script>
    <script charset="utf-8" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
    <script charset="utf-8" src="__PUBLIC__/ueditor/ueditor.all.min.js"></script>
    <script src="__PUBLIC__/ueditor/lang/zh-cn/zh-cn.js"></script>
    <script src="__PUBLIC__/common/js/util.js"></script>
    <title>后台首页</title>
    <link rel="shortcut icon" href="__PUBLIC__/common/images/logo.png">
    <style>
        body{background:#f2f2f2;}
        .menu_box_ul a:hover{color: #961949;}
        .sub_menu li{margin-top:4px;margin-left:-10px;}
        .topB li a{float:left;margin-left:6px;background:#b9637e;color:white;line-height:20px;padding:5px;border-radius:4px;text-decoration:none;}
        .topB ul{float:right;}
        .cenB li{float:left;}
        .cenB a{text-decoration:none;}
        .cenB{padding-top:10px;}
        .name>li{line-height:71px;}
    </style>
</head>
<body class="index-body">
<div id="header">
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="logo">
                <img class="img-responsive center-block" src="__PUBLIC__/common/images/logo1.png">
            </div>
            <ul class="name">
                <li><a href="#">{$Think.session.username}</a></li>
                <li><a href="{:url('admin/login/tc')}">退出</a></li>
            </ul>
        </div>
    </nav>

</div>
<div id="contents">
    <div class="container pot">
        <div id="content-left" class="col-md-2">
            <div class="menu_box">
                <ul class="menu_box_ul">
                    <li>
                        <h4 class=""><i class="fa fa-fw fa-clipboard glyphicon glyphicon-sound-5-1"></i>&nbsp;资讯中心</h4>
                        <ul class="sub_menu">
                            <li class=""><a href="{:url('admin/index/publish')}" target="main">发布资讯</a></li>
                            <li class=""><a href="{:url('admin/index/plist')}" target="main">资讯列表</a></li>
                        </ul>
                    </li>
                    <li>
                        <h4><i class="fa fa-fw fa-clipboard glyphicon glyphicon-tags"></i>&nbsp;产品中心</h4>
                        <ul class="sub_menu">
                            <li class=""><a href="{:url('admin/product/publishwine')}" target="main">发布产品</a></li>
                            <li class=""><a href="{:url('admin/product/winelist')}" target="main">产品列表</a></li>
                        </ul>
                    </li>

                </ul>
            </div>
        </div>
        <div id="content-right" class="col-md-10" style="background:white;">
            <div class="result_wrap" name="main">
                <form class="form-horizontal publish-form" onsubmit="return false;">
                    <div class="cenB clearfix">
                        <ul>
                            <li><a href="###"><i class="glyphicon glyphicon-sound-5-1"></i>&nbsp;资讯中心</a></li>
                            <li>>></li>
                            <li><a href="###">资讯列表</a></li>
                        </ul>
                    </div>
                    <span style="width: 100px;height: 30px;display: block;"></span>
                    <div class="topB clearfix">
                        <ul>
                            <li><a href="{:url('admin/index/publish')}">发布资讯</a></li>
                        </ul>
                    </div>
                    <div class="form-group group_value">
                        <label  class="col-sm-2 control-label">分类：</label>
                        <div class="col-sm-10">
                            <select name="parent_c" id="parent-c" class="form-control" style="width: 20%">
                                <option value="0">请选择分类</option>
                                <option value="1">行业动态</option>
                                <option value="2">公司新闻</option>
                                <option value="3">红酒百科</option>

                            </select>
                            <span id="selectMid"></span>
                        </div>
                    </div>
                    <div class="form-group group_value">
                        <label  class="col-sm-2 control-label">文章标题：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="title" name="title"  placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label  class="col-sm-2 control-label">文章摘要：</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="6" cols="80" id="abstract" name="abstract" placeholder="建议不要超过100个字"></textarea>
                        </div>
                    </div>
                    <div class="form-group group_value">
                        <label  class="col-sm-2 control-label">作者：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="author" name="author"  placeholder=""  style="width: 20%">
                        </div>
                    </div>
                    <div class="form-group group_value">
                        <label  class="col-sm-2 control-label">来源：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="source" name="source"  placeholder="" style="width: 20%">
                        </div>
                    </div>
                    <div class="form-group group_value">
                        <label  class="col-sm-2 control-label">文章封面：</label>
                        <div class="col-sm-10">
                            <button class="btn btn-success btn-img">点此上传封面</button>
                            <input type="text" class="form-control hide" id="img-input" name="banner"  placeholder="">
                            <img class="article-cover" src="#" style="display: none;" id="jj">
                            <span class="btn .btn-danger">上传该分类下的图片(图片尺寸：390*210)</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-sm-2 control-label">文章正文：</label>
                        <div class="col-sm-10" id="emditor-sm-box">
                            <!--style给定宽度可以影响编辑器的最终宽度-->
                            <script type="text/plain" id="myEditor" style="width: 100%; height: 350px;"></script>
                        </div>
                    </div>


                    <div class="form-group publish-box">
                        <div class="col-sm-offset-2 col-sm-10 clearfix">
                            <button class="btn btn-default btn-cancel hide" onclick="javascript: history.back()">取消</button>
                            <button class="btn btn-default btn-preview hide">预览</button>
                            <button type="submit" class="btn btn-primary btn-publish">发布</button>
                            <input type="hidden" id="edit">
                        </div>
                    </div>
                </form>
                <form action="#" class="hide" id="cover-form">
                    <input type="file" name="img" id="img" accept="image/*" src="__PUBLIC__/upload/history-1.jpg">
                </form>
            </div>
        </div>
    </div>

</div>
<div class="row foot-buttom">
    <div class="col-sm-12">
        <p class="text-center">
            Copyright @ 2014-2018.
            <a href="#">上海臧星阁文化发展有限公司</a>
            All Rights Reserved
            <a>沪ICP备17055257号</a>
        </p>
                        <p style="text-align:center">技术支持:<a href="http://www.qiniuniu.com/"> <img src="__PUBLIC__/common/images/qiniuniu.png" alt=""></a></p>
    </div>
</div>
<script>
    var scope = {};
    //实例化编辑器
    var ue = UE.getEditor('myEditor');
    $(".btn-img").on("click", function () {
        $("#img").click();
    })
    function form_submit(formid, action, callback) {
        var formDom = document.getElementById(formid);
        var formData = new FormData(formDom);
        //
        var req = new XMLHttpRequest();
        req.open("POST",  action);
        req.onreadystatechange = function() {
            if (this.status === 200 && this.readyState === 4) {
                var res = this.response;
                typeof callback == "function" && callback(res)
            }else{
                console.log("错误");
            }
        };
        req.upload.onprogress = function (event) {
            // 进度条
            if (event.lengthComputable) {
                var complete = (event.loaded / event.total * 100 | 0);
                var progress = document.getElementById('uploadprogress');
                if(progress)
                    progress.value = progress.innerHTML = complete;
                // if(complete >= 100){
                //     document.getElementById('uploadprogress').style.display = 'none'
                // }
            }
        };
        // req.addEventListener('loadend' , function () {
        //      document.getElementById('uploadprogress').style.display = 'none'
        // })

        //将form数据发送出去
        req.send(formData);
        //避免内存泄漏
        req = null;

        return req;
    }
    $("#img").on("change", function () {
        form_submit("cover-form","fileUpload", function (res) {
            res = JSON.parse(res) || ""
            if(res.src){
                $("#img-input").val(res.src);
                $(".article-cover").attr("src", '__PUBLIC__/upload/'+decodeURIComponent(res.src)).show();
            }
        })
    })
    // 发布
    $(".btn-publish").on("click", function () {
        var imgWidth = document.getElementById("jj").width;
        var imgHeight = document.getElementById("jj").height;
        if(!(imgWidth==390&&imgHeight==210)){
            alert("图片尺寸不合格，请上传规格为390px*210px的图片");
            $(".article-cover").hide();
            return false;
        }
        var data={};
        var edit = $("#edit").val();
        console.log(edit);
        if(edit!=""){
            var url="update"
            data.id = edit;

        }else{
            var url='receiveProduct';
        }
        data.content = UE.getEditor('myEditor').getContent();
        data.title = $("#title").val();
        data.author = $("#author").val();
        data.source = $("#source").val();
        data.cid = $("#parent-c").val();
        data.banner = $("#img-input").val();
        data.abstract = $("#abstract").val();
        //console.log(data);
        if($("#title").val()==""){
            alert("请填写文章标题")
            return false;
        } if($("#author").val()==""){
            alert("请填写作者")
            return false;
        } if($("#source").val()==""){
            alert("请填写来源")
            return false;
        } if($("#abstract").val()==""){
            alert("请填写文章摘要")
            return false;
        }
        // if($("#emditor-sm-box").val()==""){
        //     alert("请填写文章正文")
        //     return false;
        // }
        $.ajax({
            url: url,
            type:"POST",
            data:data,
            dataType: 'json',
            success:function (res) {
                if(res.success){
                    location.href='plist';
                }else{
                    alert(res.msg);
                }

            }
        })
    })
    //修改
                        $(function(){
                            if($("#content-left").height() > $("#content-right").height()){
                                $("#content-right").css("height",$("#content-left").height());
                            }else{
                                $("#content-left").css("height",$("#content-right").height());
                            }
                        })

    var arr = location.href.split('?');
    var hehe = arr[1].split('=');
    var id = hehe[1];
    $.ajax({
        url:"modify",
        data:{"id":id}, //以键/值对的形式
        async : true,
        dataType : "json",
        success : function(data) {
            $("#edit").val(data.id);
            $("#title").val(data.title);
            $("#abstract").val(data.abstract);
            $("#author").val(data.author);
            $("#source").val(data.source);
            $("#parent-c").val(data.cid);
            $("#img-input").val(data.banner);

            $(".article-cover").attr("src", '__PUBLIC__/upload/'+data.banner).show();
            ue.ready(function(){
                ue.setContent(data.content);
            })

        }
    });










</script>
</body>
</html>